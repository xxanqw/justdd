name: Build and Release Arch Linux Package

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    
    steps:
      - name: Update package database
        run: pacman -Syu --noconfirm

      - name: Install build dependencies
        run: pacman -S --noconfirm git python python-pip base-devel sudo

      - name: Create build user
        run: |
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup directories
        run: |
          mkdir -p /home/builder/build
          cp -r ./* /home/builder/build/
          chown -R builder:builder /home/builder/build

      - name: Install python-uv
        run: |
          sudo -u builder bash -c "cd /home/builder/build && pip install --user uv"

      - name: Extract version
        id: extract_version
        run: |
          VERSION=$(grep -Po "(?<=pkgver=)([0-9]+\.[0-9]+\.[0-9]+)" PKGBUILD)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Version: $VERSION"

      - name: Build package
        run: |
          cd /home/builder/build
          sudo -u builder bash -c "PATH=$PATH:/home/builder/.local/bin makepkg -s --noconfirm"
          
      - name: List built packages
        run: |
          ls -la /home/builder/build/*.pkg.tar.zst

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: /home/builder/build/justdd-${{ env.VERSION }}-*.pkg.tar.zst
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
